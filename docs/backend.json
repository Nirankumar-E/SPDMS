{
  "entities": {
    "UserAccount": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "UserAccount",
      "type": "object",
      "description": "Represents a user account within the TN-PDS portal replica, storing login and account details.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the user account."
        },
        "username": {
          "type": "string",
          "description": "The username chosen by the user during account creation."
        },
        "smartCardNumber": {
          "type": "string",
          "description": "The Smart Card number associated with the user account."
        },
        "aadhaarNumber": {
          "type": "string",
          "description": "The masked Aadhaar number associated with the user account."
        },
        "createdAt": {
          "type": "string",
          "description": "Timestamp indicating when the user account was created.",
          "format": "date-time"
        }
      },
      "required": [
        "id",
        "username",
        "smartCardNumber",
        "aadhaarNumber",
        "createdAt"
      ]
    },
    "LoginAttempt": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "LoginAttempt",
      "type": "object",
      "description": "Stores data related to a user's login attempt, including success status and timestamp.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the login attempt."
        },
        "userAccountId": {
          "type": "string",
          "description": "Reference to UserAccount. (Relationship: UserAccount 1:N LoginAttempt)"
        },
        "timestamp": {
          "type": "string",
          "description": "Timestamp of the login attempt.",
          "format": "date-time"
        },
        "successful": {
          "type": "boolean",
          "description": "Indicates whether the login attempt was successful."
        },
        "otpSent": {
          "type": "boolean",
          "description": "Indicates whether OTP was sent during this login attempt."
        }
      },
      "required": [
        "id",
        "userAccountId",
        "timestamp",
        "successful",
        "otpSent"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/users/{userId}",
        "definition": {
          "entityName": "UserAccount",
          "schema": {
            "$ref": "#/backend/entities/UserAccount"
          },
          "description": "Stores user account information. Path-based ownership: only the user can access their data.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, corresponding to the Firebase Auth UID."
            }
          ]
        }
      },
      {
        "path": "/users/{userId}/login_attempts/{loginAttemptId}",
        "definition": {
          "entityName": "LoginAttempt",
          "schema": {
            "$ref": "#/backend/entities/LoginAttempt"
          },
          "description": "Stores login attempts for a specific user. This subcollection enables path-based ownership, restricting access to the user and securing list operations.",
          "params": [
            {
              "name": "userId",
              "description": "The unique identifier of the user, corresponding to the Firebase Auth UID."
            },
            {
              "name": "loginAttemptId",
              "description": "The unique identifier for the login attempt."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to securely manage user accounts and login attempts for the TN-PDS portal replica. It prioritizes authorization independence and simplifies security rules by avoiding hierarchical authorization dependencies.\n\n*   **/users/{userId}**: This collection stores user account details. The path-based ownership (`/users/{userId}`) ensures that only the user has access to their account data. The `userId` from `request.auth.uid` is used to enforce this ownership.\n*   **/users/{userId}/login_attempts/{loginAttemptId}**: This subcollection stores login attempts for each user. The subcollection is located under the user's document to leverage path-based security. Because of the path `/users/{userId}` we implicitly knows the owner. This structure facilitates secure listing of login attempts, satisfying the QAPs (Rules are not Filters) requirement. The `userAccountId` field within each `LoginAttempt` document is redundant and should be equivalent to the wildcard `{userId}`. While redundant, explicitly including `userAccountId` can aid in debugging and reporting.\n\nThis structure adheres to the core design principles:\n\n1.  **Authorization Independence:** Security rules rely on the `request.auth.uid` and the document path, avoiding `get()` calls to parent documents. The user ID is implicitly available from the path itself.\n2.  **Clarity of Intent:** The structure clearly reflects the ownership and relationship between users and their login attempts.\n3.  **DBAC:** Authorization is based solely on `request.auth.uid` and the document paths. No custom claims are used.\n4.  **QAPs:** The structure supports secure `list` operations. For example, listing login attempts for a user is done via the `/users/{userId}/login_attempts` collection, where the security rules can easily verify the user's ownership.\n5.  **Invariants:** Path-based ownership (`/users/{userId}`) ensures the integrity of user data and prevents unauthorized access.\n\nThe design also implements the following strategies:\n\nA.  **Authorization Independence via Denormalization:** While not explicitly denormalized, this structure intrinsically implements this strategy through Path-Based Ownership. The ownership is expressed via the path itself: `/users/{userId}`. This implicitly provides the authorization context without requiring field denormalization.\n\nB.  **Structural Segregation:** User accounts and login attempts are stored in separate collections/subcollections, each with its specific security requirements. Private user data is stored under `/users/{userId}`, and login attempts are further nested under each user.\n\nC.  **Access Modeling:** The design follows the principles of access modeling:\n\n    *   Private data: Uses path-based ownership (`/users/{userId}`) for user accounts.\n    *   Hierarchical paths: Uses hierarchical paths (`/users/{userId}/login_attempts`) to represent the one-to-many relationship between users and their login attempts.\n\nD.  **Data Clarity and Predictability:** The structure uses explicit naming conventions and avoids dynamic keys. The timestamps are named consistently (`createdAt`, `timestamp`)."
  }
}