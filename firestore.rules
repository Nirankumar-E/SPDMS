
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages citizen profiles.
     * @path /citizens/{citizenId}
     * @allow (read) Unauthenticated user querying for a smart card number to initiate login.
     * @allow (read) An authenticated user reading their own profile document.
     * @allow (update) An authenticated user updating their own profile document.
     * @deny (create, delete) Clients are not allowed to create or delete citizen profiles.
     * @deny (list) Authenticated users are not allowed to list all citizens.
     */
    match /citizens/{citizenId} {
      // Combined read rule:
      // - Allows unauthenticated users to query ONLY by smartCardNumber for login.
      // - Allows authenticated users to get their own document.
      allow read: if (!isSignedIn() && request.query.keys().hasOnly(['smartCardNumber'])) || isOwner(citizenId);

      // Allow authenticated users to update their own document.
      allow update: if isOwner(citizenId);
      
      // Disallow client-side creation or deletion of citizen records.
      allow create, delete: if false;
    }

    /**
     * @description Stores ration collection bookings. Access is strictly limited to the owner.
     * @path /bookings/{citizenId}
     * @allow (get, create, update, delete) An authenticated user managing their own booking.
     * @deny (list) Listing all bookings is disallowed.
     */
    match /bookings/{citizenId} {
      allow get, create, update, delete: if isOwner(citizenId);
      allow list: if false;
    }
  }
}
