
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages citizen profiles. Only the owner can read or modify their own profile.
     * A special list rule allows unauthenticated users to query for a smart card number for the login flow.
     * @path /citizens/{citizenId}
     * @allow (list) Unauthenticated user querying for a smart card number to initiate login.
     * @allow (get, update) An authenticated user reading or updating their own profile document.
     * @deny (create, delete) Clients are not allowed to create or delete citizen profiles.
     * @deny (list) Authenticated users are not allowed to list all citizens.
     */
    match /citizens/{citizenId} {
      // Allow unauthenticated users to query by smartCardNumber for login purposes ONLY.
      // This is secure because it only allows a query on this specific field.
      allow list: if !isSignedIn() && request.query.keys().hasOnly(['smartCardNumber']);

      // Allow authenticated users to read and write to their own document.
      allow get, update: if isOwner(citizenId);
      
      // Disallow client-side creation or deletion of citizen records.
      allow create, delete: if false;
    }

    /**
     * @description Stores ration collection bookings. Access is strictly limited to the owner.
     * @path /bookings/{citizenId}
     * @allow (get, create, update, delete) An authenticated user managing their own booking.
     * @deny (list) Listing all bookings is disallowed.
     */
    match /bookings/{citizenId} {
      allow get, create, update, delete: if isOwner(citizenId);
      allow list: if false;
    }
  }
}
