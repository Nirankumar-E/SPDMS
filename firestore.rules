
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages citizen profiles.
     * @path /citizens/{citizenId}
     * @allow (read) Allows an authenticated user to read their own profile.
     * @allow (read) Allows querying the collection by `smartCardNumber` for login.
     * @allow (update) An authenticated user updating their own profile document.
     * @deny (create, delete) Clients are not allowed to create or delete citizen profiles.
     */
    match /citizens/{citizenId} {
      // Read is allowed if the user is the owner, OR if the request is a query
      // filtering by smartCardNumber. This enables the login flow to find a user.
      // NOTE: This rule is permissive for development. For production, a Cloud Function
      // for lookup would be more secure to avoid leaking document data on queries.
      allow read: if isOwner(citizenId) || request.query.keys().hasOnly(['smartCardNumber']);

      // Allow authenticated users to update their own document.
      allow update: if isOwner(citizenId);
      
      // Disallow client-side creation or deletion of citizen records.
      allow create, delete: if false;
    }

    /**
     * @description Stores ration collection bookings. Access is strictly limited to the owner.
     * @path /bookings/{citizenId}
     * @allow (get, create, update, delete) An authenticated user managing their own booking.
     * @deny (list) Listing all bookings is disallowed.
     */
    match /bookings/{citizenId} {
      allow get, create, update, delete: if isOwner(citizenId);
      allow list: if false;
    }
  }
}
